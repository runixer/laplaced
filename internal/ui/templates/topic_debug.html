{{template "layout.html" .}}

{{define "title"}}Topic Extraction Debug{{end}}

{{define "content"}}
<div class="container mt-4">

    <div class="card mb-4">
        <div class="card-header">Logs (Total: {{.Data.Total}})</div>
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Log Time</th>
                        <th>Chunk Date</th>
                        <th>User ID</th>
                        <th>Input (Msgs)</th>
                        <th>Range</th>
                        <th>Topics</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Data.Logs}}
                    <tr class="{{if .ParseError}}table-danger{{end}}">
                        <td>{{.ID}}</td>
                        <td>{{.CreatedAt.Format "02.01 15:04:05"}}</td>
                        <td>
                            {{if not .ChunkDate.IsZero}}
                                {{.ChunkDate.Format "02.01 15:04"}}
                            {{else}}
                                -
                            {{end}}
                        </td>
                        <td>{{.UserID}}</td>
                        <td>{{.InputMsgCount}}</td>
                        <td>{{.InputStartID}} - {{.InputEndID}}</td>
                        <td>{{len .ParsedTopics}}</td>
                        <td>
                            {{if .ParseError}}
                                <span class="badge bg-danger">Error</span>
                            {{else}}
                                <span class="badge bg-success">Success</span>
                            {{end}}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#details-{{.ID}}">
                                Details
                            </button>
                        </td>
                    </tr>
                    <tr class="collapse" id="details-{{.ID}}">
                        <td colspan="9">
                            <div class="card card-body bg-light">
                                {{if .ParseError}}
                                    <div class="alert alert-danger">
                                        <strong>Parse Error:</strong> {{.ParseError}}
                                    </div>
                                    <h5>Raw Response:</h5>
                                    <pre style="white-space: pre-wrap; word-wrap: break-word;">{{.LLMResponse}}</pre>
                                {{else}}
                                    <h5>Extracted Topics ({{len .ParsedTopics}})</h5>
                                    <div class="list-group mb-3">
                                        {{range .ParsedTopics}}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">{{.Summary}}</h6>
                                                <small>IDs: {{.StartMsgID}} - {{.EndMsgID}} (Size: {{add64 (sub64 .EndMsgID .StartMsgID) 1}})</small>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                {{end}}

                                <div class="mt-2">
                                    <button class="btn btn-sm btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#raw-{{.ID}}">
                                        Show Raw Data
                                    </button>
                                    <div class="collapse mt-2" id="raw-{{.ID}}">
                                        <h6>System Prompt</h6>
                                        <pre class="small" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">{{.SystemPrompt}}</pre>
                                        <h6>Context Used</h6>
                                        <pre class="small" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">{{.ContextUsed}}</pre>
                                        <h6>LLM Response</h6>
                                        <pre class="small" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">{{.LLMResponse}}</pre>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>

            <!-- Pagination -->
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {{if gt .Data.Page 1}}
                    <li class="page-item"><a class="page-link" href="?page={{sub .Data.Page 1}}">Previous</a></li>
                    {{end}}
                    <li class="page-item disabled"><a class="page-link" href="#">Page {{.Data.Page}} of {{.Data.Pages}}</a></li>
                    {{if lt .Data.Page .Data.Pages}}
                    <li class="page-item"><a class="page-link" href="?page={{add .Data.Page 1}}">Next</a></li>
                    {{end}}
                </ul>
            </nav>
        </div>
    </div>
</div>
{{end}}
