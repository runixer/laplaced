{{define "title"}}{{.Data.AgentName}}{{end}}

{{define "styles"}}
<style>
    .log-entry { margin-bottom: 1.5rem; }
    .log-header { cursor: pointer; }
    .log-header:hover { background-color: #f8f9fa; }
    .log-content { display: none; }
    .log-content.show { display: block; }
    .json-view {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        font-family: monospace;
        font-size: 0.85rem;
        max-height: 400px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-word;
    }
    .response-view {
        background: #d1e7dd;
        padding: 1rem;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        max-height: 300px;
        overflow: auto;
        white-space: pre-wrap;
    }
    .error-badge { background-color: #dc3545; }
    .success-badge { background-color: #198754; }
    .metric-card {
        text-align: center;
        padding: 0.5rem;
    }
    .metric-value {
        font-size: 1.25rem;
        font-weight: bold;
    }
    .metric-label {
        font-size: 0.75rem;
        color: #6c757d;
    }

    /* OpenRouter Request Viewer */
    .openrouter-request {
        background: #fff;
        border-radius: 0.5rem;
        padding: 1rem;
        border: 1px solid #dee2e6;
    }
    .or-error {
        color: #dc3545;
        padding: 1rem;
        background: #f8d7da;
        border-radius: 0.5rem;
    }
    .or-header {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
        align-items: center;
    }
    .or-model-badge {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-weight: 600;
        font-size: 0.875rem;
    }
    .or-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    .or-badge-reasoning { background: #fef3c7; color: #92400e; }
    .or-badge-format { background: #dbeafe; color: #1e40af; }
    .or-badge-plugin { background: #f3e8ff; color: #7c3aed; }
    .or-badge-tools { background: #e0e7ff; color: #4338ca; }

    .or-messages {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .or-message {
        border-radius: 0.5rem;
        padding: 0.75rem;
    }
    .or-message-system {
        background: #f3f4f6;
        border-left: 3px solid #9ca3af;
    }
    .or-message-user {
        background: #fef3c7;
        border-left: 3px solid #f59e0b;
    }
    .or-message-assistant {
        background: #d1fae5;
        border-left: 3px solid #10b981;
    }
    .or-message-tool {
        background: #dbeafe;
        border-left: 3px solid #3b82f6;
    }
    .or-role {
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }
    .or-message-content {
        font-size: 0.9rem;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 300px;
        overflow: auto;
    }
    .or-message-content.collapsed {
        display: none;
    }
    .or-message-header {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .or-preview {
        color: #9ca3af;
        font-size: 0.875rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }
    .or-tool-call {
        background: #f0fdf4;
        border: 1px solid #86efac;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin-top: 0.5rem;
    }
    .or-tool-badge {
        background: #22c55e;
        color: white;
        font-size: 0.65rem;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        text-transform: uppercase;
    }
    .or-tool-id {
        font-size: 0.7rem;
        color: #6b7280;
        margin-left: 0.5rem;
    }
    .or-tool-args {
        margin: 0.5rem 0 0 0;
        font-size: 0.8rem;
        background: #f8fafc;
        padding: 0.5rem;
        border-radius: 0.25rem;
        max-height: 150px;
        overflow: auto;
    }
    .or-multimodal-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        background: #fef3c7;
        color: #92400e;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        margin-bottom: 0.5rem;
    }
    .or-image {
        margin-top: 0.5rem;
        position: relative;
        display: inline-block;
    }
    .or-image img {
        max-width: 200px;
        max-height: 150px;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
    }
    .or-image-badge {
        position: absolute;
        top: 0.25rem;
        left: 0.25rem;
        background: rgba(0,0,0,0.6);
        color: white;
        font-size: 0.65rem;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
    }
    .or-tools-section {
        margin-top: 1rem;
        border-top: 1px solid #e9ecef;
        padding-top: 0.75rem;
    }
    .or-section-header {
        cursor: pointer;
        font-weight: 600;
        font-size: 0.875rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #6b7280;
    }
    .or-section-content.collapsed {
        display: none;
    }
    .or-tool {
        background: #f9fafb;
        padding: 0.5rem;
        border-radius: 0.375rem;
        margin-top: 0.5rem;
    }
    .or-tool-name {
        background: #e0e7ff;
        color: #4338ca;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-family: monospace;
    }
    .or-tool-desc {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 0.25rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
    .or-tool-schema {
        font-size: 0.75rem;
        background: #fff;
        padding: 0.5rem;
        border-radius: 0.25rem;
        max-height: 200px;
        overflow: auto;
        margin: 0.5rem 0 0 0;
    }

    /* XML Tag Visualization */
    .or-xml-section {
        border-radius: 0.5rem;
        margin: 0.5rem 0;
        overflow: hidden;
    }
    .or-xml-header {
        cursor: pointer;
        font-weight: 600;
        padding: 0.5rem 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .or-xml-header i {
        font-size: 0.7rem;
        margin-left: auto;
    }
    .or-xml-content {
        padding: 0.75rem;
        font-size: 0.85rem;
        white-space: pre-wrap;
        word-break: break-word;
        border-top: 1px solid rgba(0,0,0,0.1);
    }
    .or-xml-content.collapsed {
        display: none;
    }
    .or-xml-attr {
        font-size: 0.7rem;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-weight: 500;
        text-transform: none;
        letter-spacing: 0;
    }
    .or-xml-plain {
        padding: 0.5rem 0;
        font-size: 0.85rem;
        white-space: pre-wrap;
        color: #4b5563;
    }

    /* Tag type colors */
    .or-xml-role { background: #f3e8ff; border-left: 3px solid #7c3aed; }
    .or-xml-role .or-xml-header { color: #7c3aed; }
    .or-xml-role .or-xml-attr { background: #7c3aed; color: white; }

    .or-xml-critical { background: #fee2e2; border-left: 3px solid #dc2626; }
    .or-xml-critical .or-xml-header { color: #dc2626; }
    .or-xml-critical .or-xml-attr { background: #dc2626; color: white; }

    .or-xml-process { background: #dbeafe; border-left: 3px solid #3b82f6; }
    .or-xml-process .or-xml-header { color: #3b82f6; }
    .or-xml-process .or-xml-attr { background: #3b82f6; color: white; }

    .or-xml-data { background: #fef3c7; border-left: 3px solid #f59e0b; }
    .or-xml-data .or-xml-header { color: #92400e; }
    .or-xml-data .or-xml-attr { background: #f59e0b; color: white; }

    .or-xml-constraints { background: #f3f4f6; border-left: 3px solid #6b7280; }
    .or-xml-constraints .or-xml-header { color: #6b7280; }
    .or-xml-constraints .or-xml-attr { background: #6b7280; color: white; }

    .or-xml-output { background: #d1fae5; border-left: 3px solid #10b981; }
    .or-xml-output .or-xml-header { color: #10b981; }
    .or-xml-output .or-xml-attr { background: #10b981; color: white; }

    .or-xml-default { background: #f9fafb; border-left: 3px solid #9ca3af; }
    .or-xml-default .or-xml-header { color: #6b7280; }
    .or-xml-default .or-xml-attr { background: #9ca3af; color: white; }

    /* Nested XML sections (e.g., topics inside retrieved_context) */
    .or-xml-section .or-xml-section {
        margin: 0.5rem 0;
        border-radius: 0.5rem;
    }
    .or-xml-content > .or-xml-section:first-child {
        margin-top: 0;
    }
    .or-xml-content > .or-xml-section:last-child {
        margin-bottom: 0;
    }

    /* Special styling for topic cards inside retrieved_context */
    .or-xml-topic-card {
        background: #fffbeb;
        border: 1px solid #fcd34d;
        border-left: 4px solid #f59e0b;
        border-radius: 0.5rem;
        margin: 0.75rem 0;
        overflow: hidden;
    }
    .or-xml-topic-card .or-xml-header {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        padding: 0.5rem 0.75rem;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
        border-bottom: 1px solid #fcd34d;
    }
    .or-xml-topic-card .or-xml-header .topic-id {
        background: #f59e0b;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 600;
        font-size: 0.75rem;
    }
    .or-xml-topic-card .or-xml-header .topic-meta {
        display: flex;
        gap: 0.5rem;
        margin-left: auto;
    }
    .or-xml-topic-card .or-xml-header .topic-relevance {
        background: #dcfce7;
        color: #166534;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.7rem;
        font-weight: 500;
    }
    .or-xml-topic-card .or-xml-header .topic-relevance.high { background: #bbf7d0; }
    .or-xml-topic-card .or-xml-header .topic-relevance.medium { background: #fef08a; color: #854d0e; }
    .or-xml-topic-card .or-xml-header .topic-relevance.low { background: #fecaca; color: #991b1b; }
    .or-xml-topic-card .or-xml-header .topic-date {
        background: #e0e7ff;
        color: #3730a3;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.7rem;
    }
    .or-xml-topic-card .topic-summary {
        padding: 0.75rem;
        font-size: 0.9rem;
        line-height: 1.4;
        color: #1f2937;
    }
    .or-xml-topic-card .topic-content-toggle {
        background: #fef3c7;
        padding: 0.5rem 0.75rem;
        border-top: 1px solid #fcd34d;
        cursor: pointer;
        font-size: 0.8rem;
        color: #92400e;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .or-xml-topic-card .topic-content-toggle:hover {
        background: #fde68a;
    }
    .or-xml-topic-card .topic-content {
        background: #fffef5;
        padding: 0.75rem;
        border-top: 1px solid #fcd34d;
        font-size: 0.85rem;
        white-space: pre-wrap;
        max-height: 300px;
        overflow: auto;
    }
    .or-xml-topic-card .topic-content.collapsed {
        display: none;
    }

    /* OpenRouter Response Viewer */
    .openrouter-response {
        background: #fff;
        border-radius: 0.5rem;
        padding: 1rem;
        border: 1px solid #dee2e6;
    }
    .orr-header {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
        align-items: center;
    }
    .orr-id-badge {
        background: #6b7280;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.7rem;
        font-family: monospace;
    }
    .orr-model-badge {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-weight: 600;
        font-size: 0.875rem;
    }
    .orr-finish-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    .orr-finish-stop { background: #d1fae5; color: #065f46; }
    .orr-finish-tool_calls { background: #fef3c7; color: #92400e; }
    .orr-finish-length, .orr-finish-max_tokens { background: #fee2e2; color: #991b1b; }
    .orr-finish-content_filter { background: #fecaca; color: #b91c1c; }
    .orr-finish-default { background: #e5e7eb; color: #374151; }

    .orr-usage {
        display: flex;
        gap: 0.5rem;
        margin-left: auto;
    }
    .orr-usage-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        background: #dbeafe;
        color: #1e40af;
    }
    .orr-cost-badge {
        background: #d1fae5;
        color: #065f46;
    }

    .orr-choices {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .orr-choice {
        background: #d1fae5;
        border-left: 3px solid #10b981;
        border-radius: 0.5rem;
        padding: 0.75rem;
    }
    .orr-choice-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .orr-choice-index {
        background: #10b981;
        color: white;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.65rem;
        font-weight: 600;
    }
    .orr-role {
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #047857;
    }
    .orr-content {
        font-size: 0.9rem;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 300px;
        overflow: auto;
    }
    .orr-reasoning {
        background: #fef3c7;
        border-left: 3px solid #f59e0b;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin-top: 0.5rem;
    }
    .orr-reasoning-header {
        font-weight: 600;
        font-size: 0.75rem;
        color: #92400e;
        margin-bottom: 0.25rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .orr-reasoning-content {
        font-size: 0.85rem;
        white-space: pre-wrap;
        max-height: 200px;
        overflow: auto;
    }
    .orr-reasoning-content.collapsed {
        display: none;
    }

    /* Multi-turn conversation styles */
    .conversation-turns {
        border: 2px solid #6366f1;
        border-radius: 0.5rem;
        padding: 1rem;
        background: #f8f9ff;
    }
    .conversation-turns h6 {
        color: #4338ca;
        margin-bottom: 0.75rem;
    }
    .conversation-turns .badge {
        font-size: 0.7rem;
    }
    .conversation-turns .accordion-item {
        border: 1px solid #c7d2fe;
        margin-bottom: 0.5rem;
        border-radius: 0.375rem;
        overflow: hidden;
    }
    .conversation-turns .accordion-button {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        background: #eef2ff;
    }
    .conversation-turns .accordion-button:not(.collapsed) {
        background: #e0e7ff;
        color: #3730a3;
    }
    .conversation-turns .accordion-button .badge {
        margin-left: 0.5rem;
    }
    .conversation-turns .accordion-body {
        padding: 0.75rem;
        background: white;
    }
    .turn-request, .turn-response {
        margin-bottom: 0.75rem;
    }
    .turn-request h6, .turn-response h6 {
        font-size: 0.8rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
    }
</style>
{{end}}

{{define "content"}}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h4><i class="bi bi-{{.Data.AgentIcon}}"></i> {{.Data.AgentName}} Agent Logs</h4>
            <p class="text-muted">{{.Data.AgentDescription}}</p>
        </div>
    </div>

    {{if not .Data.Logs}}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> No logs yet. Agent logs will appear here when {{.Data.AgentName}} processes requests.
    </div>
    {{else}}

    {{range $idx, $log := .Data.Logs}}
    <div class="card log-entry">
        <div class="card-header log-header d-flex justify-content-between align-items-center" onclick="toggleLog({{$idx}})">
            <div>
                <span class="badge {{if $log.Success}}success-badge{{else}}error-badge{{end}} me-2">
                    {{if $log.Success}}OK{{else}}ERROR{{end}}
                </span>
                <span class="text-muted">{{$log.CreatedAt.Format "2006-01-02 15:04:05"}}</span>
                {{if $log.Model}}
                <span class="badge bg-secondary ms-2">{{$log.Model}}</span>
                {{end}}
            </div>
            <div class="d-flex align-items-center">
                {{if $log.DurationMs}}
                <div class="metric-card me-3">
                    <div class="metric-value">{{$log.DurationMs}}ms</div>
                    <div class="metric-label">Duration</div>
                </div>
                {{end}}
                {{if $log.PromptTokens}}
                <div class="metric-card me-3">
                    <div class="metric-value">{{$log.PromptTokens}}</div>
                    <div class="metric-label">Prompt</div>
                </div>
                {{end}}
                {{if $log.CompletionTokens}}
                <div class="metric-card me-3">
                    <div class="metric-value">{{$log.CompletionTokens}}</div>
                    <div class="metric-label">Completion</div>
                </div>
                {{end}}
                {{if $log.TotalCost}}
                <div class="metric-card">
                    <div class="metric-value">${{printf "%.4f" (deref $log.TotalCost)}}</div>
                    <div class="metric-label">Cost</div>
                </div>
                {{end}}
                <i class="bi bi-chevron-down ms-3"></i>
            </div>
        </div>
        <div class="card-body log-content" id="log-{{$idx}}">
            {{if not $log.Success}}
            <div class="alert alert-danger">
                <strong>Error:</strong> {{$log.ErrorMessage}}
            </div>
            {{end}}

            {{if $log.ConversationTurns}}
            <!-- Multi-turn conversation display -->
            <div class="conversation-turns mb-3" id="conv-turns-{{$idx}}">
                <h6>
                    <i class="bi bi-arrow-repeat"></i> Multi-Turn Conversation
                    <span class="badge bg-info turns-count">Loading...</span>
                </h6>
                <div class="accordion" id="turns-accordion-{{$idx}}">
                    <!-- Turns will be rendered by JavaScript -->
                </div>
            </div>
            <script>
            (function() {
                const turnsData = {{$log.ConversationTurns | jsString}};
                // Defer until DOM is ready and renderConversationTurns is defined
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        renderConversationTurns({{$idx}}, turnsData);
                    });
                } else {
                    // DOM already loaded, but function may not be defined yet - defer to next tick
                    setTimeout(function() {
                        renderConversationTurns({{$idx}}, turnsData);
                    }, 0);
                }
            })();
            </script>
            {{else}}
            {{if $log.InputContext}}
            <div class="mb-3">
                <h6>
                    API Request
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleRawJSON({{$idx}}); event.stopPropagation();">
                        <i class="bi bi-code"></i> Raw JSON
                    </button>
                </h6>
                <div class="openrouter-request" id="or-request-{{$idx}}"></div>
                <div class="json-view mt-2" id="or-raw-{{$idx}}" style="display: none;">{{$log.InputContext | prettyJSON}}</div>
            </div>
            {{end}}

            {{if $log.OutputContext}}
            <div class="mb-3">
                <h6>
                    API Response
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleRawResponseJSON({{$idx}}); event.stopPropagation();">
                        <i class="bi bi-code"></i> Raw JSON
                    </button>
                </h6>
                <div class="openrouter-response" id="or-response-{{$idx}}"></div>
                <div class="json-view mt-2" id="or-response-raw-{{$idx}}" style="display: none;">{{$log.OutputContext | prettyJSON}}</div>
            </div>
            {{else}}
            <div class="mb-3">
                <h6>Output Response</h6>
                <div class="response-view">{{if $log.OutputResponse}}{{$log.OutputResponse}}{{else}}<em>No response</em>{{end}}</div>
            </div>
            {{end}}
            {{end}}

        </div>
    </div>
    {{end}}

    {{end}}
</div>
{{end}}

{{define "scripts"}}
<script>
function toggleLog(idx) {
    const content = document.getElementById('log-' + idx);
    content.classList.toggle('show');
}

function toggleRawJSON(idx) {
    const raw = document.getElementById('or-raw-' + idx);
    const request = document.getElementById('or-request-' + idx);
    if (raw.style.display === 'none') {
        raw.style.display = 'block';
        request.style.display = 'none';
    } else {
        raw.style.display = 'none';
        request.style.display = 'block';
    }
}

function toggleRawResponseJSON(idx) {
    const raw = document.getElementById('or-response-raw-' + idx);
    const response = document.getElementById('or-response-' + idx);
    if (raw.style.display === 'none') {
        raw.style.display = 'block';
        response.style.display = 'none';
    } else {
        raw.style.display = 'none';
        response.style.display = 'block';
    }
}

function toggleORMessage(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('i.bi');
    content.classList.toggle('collapsed');
    if (icon) {
        icon.classList.toggle('bi-chevron-down');
        icon.classList.toggle('bi-chevron-up');
    }
}

function toggleORSection(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('i.bi');
    content.classList.toggle('collapsed');
    if (icon) {
        icon.classList.toggle('bi-chevron-down');
        icon.classList.toggle('bi-chevron-up');
    }
}

// Render multi-turn conversation accordion
function renderConversationTurns(logIdx, turnsDataStr) {
    const container = document.getElementById('conv-turns-' + logIdx);
    const accordion = document.getElementById('turns-accordion-' + logIdx);
    if (!container || !accordion) return;

    let data;
    try {
        data = JSON.parse(turnsDataStr);
    } catch(e) {
        console.error('Failed to parse conversation turns:', e);
        return;
    }

    if (!data.turns || !data.turns.length) {
        container.style.display = 'none';
        return;
    }

    // Update badge with turns count
    const badge = container.querySelector('.turns-count');
    if (badge) {
        badge.textContent = data.turns.length + ' turns';
    }

    // Build accordion HTML
    let html = '';
    for (let i = 0; i < data.turns.length; i++) {
        const turn = data.turns[i];
        const isLast = i === data.turns.length - 1;
        const turnId = 'turn-' + logIdx + '-' + i;

        // Detect if response has tool_calls
        let hasToolCalls = false;
        let toolCallCount = 0;
        try {
            const respData = typeof turn.response === 'string' ? JSON.parse(turn.response) : turn.response;
            if (respData && respData.choices && respData.choices[0] && respData.choices[0].message && respData.choices[0].message.tool_calls) {
                hasToolCalls = true;
                toolCallCount = respData.choices[0].message.tool_calls.length;
            }
        } catch(e) {}

        // Badge for turn type
        let typeBadge = '';
        if (hasToolCalls) {
            typeBadge = '<span class="badge bg-warning text-dark"><i class="bi bi-gear"></i> ' + toolCallCount + ' tool call' + (toolCallCount > 1 ? 's' : '') + '</span>';
        } else if (isLast) {
            typeBadge = '<span class="badge bg-success"><i class="bi bi-check"></i> Final response</span>';
        }

        html += '<div class="accordion-item">' +
            '<h2 class="accordion-header">' +
                '<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#' + turnId + '">' +
                    '<strong>Turn ' + turn.iteration + '</strong>' +
                    '<span class="badge bg-secondary">' + turn.duration_ms + 'ms</span>' +
                    typeBadge +
                '</button>' +
            '</h2>' +
            '<div id="' + turnId + '" class="accordion-collapse collapse">' +
                '<div class="accordion-body">' +
                    '<div class="row">' +
                        '<div class="col-md-6 turn-request">' +
                            '<h6><i class="bi bi-arrow-up-right"></i> Request</h6>' +
                            '<div id="or-turn-req-' + logIdx + '-' + i + '"></div>' +
                        '</div>' +
                        '<div class="col-md-6 turn-response">' +
                            '<h6><i class="bi bi-arrow-down-left"></i> Response</h6>' +
                            '<div id="or-turn-resp-' + logIdx + '-' + i + '"></div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
    }

    accordion.innerHTML = html;

    // Initialize viewers for each turn
    for (let i = 0; i < data.turns.length; i++) {
        const turn = data.turns[i];
        const reqStr = typeof turn.request === 'string' ? turn.request : JSON.stringify(turn.request);
        const respStr = typeof turn.response === 'string' ? turn.response : JSON.stringify(turn.response);

        new OpenRouterRequestViewer('or-turn-req-' + logIdx + '-' + i, reqStr);
        new OpenRouterResponseViewer('or-turn-resp-' + logIdx + '-' + i, respStr);
    }
}

class OpenRouterRequestViewer {
    constructor(containerId, jsonString) {
        this.container = document.getElementById(containerId);
        this.data = null;

        try {
            this.data = JSON.parse(jsonString);
        } catch (e) {
            this.container.innerHTML = '<div class="or-error"><i class="bi bi-exclamation-triangle"></i> Invalid JSON: ' + this.escapeHtml(e.message) + '</div>';
            return;
        }

        this.render();
    }

    render() {
        const html = `
            ${this.renderHeader()}
            ${this.renderMessages()}
            ${this.renderTools()}
        `;
        this.container.innerHTML = html;
    }

    renderHeader() {
        const badges = [];

        const modelName = this.data.model || 'unknown';
        const modelDisplay = modelName.split('/').pop();

        if (this.data.reasoning && this.data.reasoning.enabled) {
            const effort = this.data.reasoning.effort || 'default';
            badges.push('<span class="or-badge or-badge-reasoning"><i class="bi bi-lightbulb"></i> reasoning: ' + this.escapeHtml(effort) + '</span>');
        }

        if (this.data.response_format) {
            const formatType = this.data.response_format.type || '';
            if (formatType === 'json_schema') {
                const schemaName = (this.data.response_format.json_schema && this.data.response_format.json_schema.name) || 'JSON';
                badges.push('<span class="or-badge or-badge-format"><i class="bi bi-braces"></i> ' + this.escapeHtml(schemaName) + '</span>');
            } else if (formatType === 'json_object') {
                badges.push('<span class="or-badge or-badge-format"><i class="bi bi-braces"></i> JSON</span>');
            }
        }

        if (this.data.plugins && this.data.plugins.length) {
            this.data.plugins.forEach(p => {
                badges.push('<span class="or-badge or-badge-plugin"><i class="bi bi-plug"></i> ' + this.escapeHtml(p.id || 'plugin') + '</span>');
            });
        }

        if (this.data.tools && this.data.tools.length) {
            badges.push('<span class="or-badge or-badge-tools"><i class="bi bi-tools"></i> ' + this.data.tools.length + ' tools</span>');
        }

        return '<div class="or-header"><span class="or-model-badge">' + this.escapeHtml(modelDisplay) + '</span>' + badges.join('') + '</div>';
    }

    renderMessages() {
        if (!this.data.messages || !this.data.messages.length) {
            return '<div class="text-muted">No messages</div>';
        }

        let html = '<div class="or-messages">';
        for (let i = 0; i < this.data.messages.length; i++) {
            html += this.renderMessage(this.data.messages[i], i);
        }
        html += '</div>';
        return html;
    }

    renderMessage(msg, idx) {
        const role = msg.role || 'unknown';

        if (role === 'system') {
            return this.renderSystemMessage(msg, idx);
        }

        if (role === 'tool') {
            return this.renderToolMessage(msg);
        }

        if (role === 'user') {
            return this.renderUserMessage(msg, idx);
        }

        const roleClass = 'or-message-' + role;
        const contentHtml = this.renderContent(msg.content);
        const toolCallsHtml = (msg.tool_calls && msg.tool_calls.length) ? this.renderToolCalls(msg.tool_calls) : '';

        return '<div class="or-message ' + roleClass + '"><div class="or-role">' + this.escapeHtml(role) + '</div><div class="or-message-content">' + contentHtml + toolCallsHtml + '</div></div>';
    }

    renderUserMessage(msg, idx) {
        const content = this.getTextContent(msg.content);
        const hasXmlTags = /<\w+[^>]*>[\s\S]*?<\/\w+>/g.test(content);

        // If content has XML tags (like RAG context), visualize them
        if (hasXmlTags) {
            const preview = content.substring(0, 120).replace(/<[^>]*>/g, '').trim() + (content.length > 120 ? '...' : '');
            const contentHtml = this.renderMessageWithTags(content);

            return '<div class="or-message or-message-user">' +
                '<div class="or-message-header" onclick="toggleORMessage(this)">' +
                    '<span class="or-role">User</span>' +
                    '<span class="or-preview">' + this.escapeHtml(preview) + '</span>' +
                    '<i class="bi bi-chevron-down"></i>' +
                '</div>' +
                '<div class="or-message-content collapsed">' + contentHtml + '</div>' +
            '</div>';
        }

        // For multimodal content or simple text, render normally
        const contentHtml = this.renderContent(msg.content);
        return '<div class="or-message or-message-user">' +
            '<div class="or-role">User</div>' +
            '<div class="or-message-content">' + contentHtml + '</div>' +
        '</div>';
    }

    renderMessageWithTags(content) {
        // Same as renderSystemMessageWithTags but for any message
        const tagRegex = /<(\w+)([^>]*)>([\s\S]*?)<\/\1>/g;

        let html = '';
        let lastIndex = 0;
        let match;

        while ((match = tagRegex.exec(content)) !== null) {
            const beforeText = content.substring(lastIndex, match.index).trim();
            if (beforeText) {
                html += '<div class="or-xml-plain">' + this.escapeHtml(beforeText) + '</div>';
            }

            const tagName = match[1];
            const attrString = match[2];
            const tagContent = match[3].trim();

            // Special rendering for <topic> tags (RAG results)
            if (tagName === 'topic') {
                html += this.renderTopicCard(attrString, tagContent);
                lastIndex = match.index + match[0].length;
                continue;
            }

            const colorClass = this.getTagColorClass(tagName);
            const attrs = this.parseAttributes(attrString);
            const isLong = tagContent.length > 200;

            let attrHtml = '';
            for (const [key, value] of Object.entries(attrs)) {
                attrHtml += '<span class="or-xml-attr">' + this.escapeHtml(key) + ': ' + this.escapeHtml(value) + '</span>';
            }

            // For nested tags (like <topic> inside <retrieved_context>), render recursively
            const hasNestedTags = /<\w+[^>]*>[\s\S]*?<\/\w+>/g.test(tagContent);
            const innerHtml = hasNestedTags
                ? this.renderMessageWithTags(tagContent)
                : this.escapeHtml(tagContent);

            html += '<div class="or-xml-section ' + colorClass + '">' +
                '<div class="or-xml-header" onclick="toggleORSection(this)">' +
                    '<span>' + this.escapeHtml(tagName) + '</span>' +
                    attrHtml +
                    (isLong || hasNestedTags ? '<i class="bi bi-chevron-down"></i>' : '') +
                '</div>' +
                '<div class="or-xml-content' + (isLong ? ' collapsed' : '') + '">' + innerHtml + '</div>' +
            '</div>';

            lastIndex = match.index + match[0].length;
        }

        const afterText = content.substring(lastIndex).trim();
        if (afterText) {
            html += '<div class="or-xml-plain">' + this.escapeHtml(afterText) + '</div>';
        }

        return html || '<pre>' + this.escapeHtml(content) + '</pre>';
    }

    renderTopicCard(attrString, tagContent) {
        const attrs = this.parseAttributes(attrString);
        const topicId = attrs.id || '?';
        const relevance = parseFloat(attrs.relevance) || 0;
        const date = attrs.date || '';
        const summary = attrs.summary || ''; // Summary is an attribute, not nested tag
        const isExcerpt = attrs.excerpt === 'true';

        // tagContent is the raw message content (not wrapped in <content>)
        const content = tagContent.trim();

        // Relevance color class
        let relevanceClass = 'low';
        if (relevance >= 0.8) relevanceClass = 'high';
        else if (relevance >= 0.6) relevanceClass = 'medium';

        const uniqueId = 'topic-content-' + Math.random().toString(36).substr(2, 9);

        let html = '<div class="or-xml-topic-card">';

        // Header with ID, relevance, date
        html += '<div class="or-xml-header">' +
            '<span class="topic-id"><i class="bi bi-chat-square-text"></i> Topic #' + this.escapeHtml(topicId) + '</span>' +
            '<div class="topic-meta">' +
                (isExcerpt ? '<span class="topic-relevance" style="background:#e0e7ff;color:#4338ca;"><i class="bi bi-scissors"></i> excerpt</span>' : '') +
                '<span class="topic-relevance ' + relevanceClass + '">' + (relevance * 100).toFixed(0) + '%</span>' +
                (date ? '<span class="topic-date"><i class="bi bi-calendar3"></i> ' + this.escapeHtml(date) + '</span>' : '') +
            '</div>' +
        '</div>';

        // Summary
        if (summary) {
            html += '<div class="topic-summary">' + this.escapeHtml(summary) + '</div>';
        }

        // Content toggle and content
        if (content) {
            const lineCount = (content.match(/\n/g) || []).length + 1;
            html += '<div class="topic-content-toggle" onclick="document.getElementById(\'' + uniqueId + '\').classList.toggle(\'collapsed\'); this.querySelector(\'i\').classList.toggle(\'bi-chevron-down\'); this.querySelector(\'i\').classList.toggle(\'bi-chevron-up\');">' +
                '<i class="bi bi-chevron-down"></i> Show conversation (' + lineCount + ' messages)' +
            '</div>';
            html += '<div id="' + uniqueId + '" class="topic-content collapsed">' + this.escapeHtml(content) + '</div>';
        }

        html += '</div>';
        return html;
    }

    renderSystemMessage(msg, idx) {
        const content = this.getTextContent(msg.content);
        const preview = content.substring(0, 120).replace(/<[^>]*>/g, '').trim() + (content.length > 120 ? '...' : '');

        // Check if content has XML-like tags
        const hasXmlTags = /<\w+[^>]*>[\s\S]*?<\/\w+>/g.test(content);

        const contentHtml = hasXmlTags
            ? this.renderSystemMessageWithTags(content)
            : '<pre>' + this.escapeHtml(content) + '</pre>';

        return '<div class="or-message or-message-system">' +
            '<div class="or-message-header" onclick="toggleORMessage(this)">' +
                '<span class="or-role">System</span>' +
                '<span class="or-preview">' + this.escapeHtml(preview) + '</span>' +
                '<i class="bi bi-chevron-down"></i>' +
            '</div>' +
            '<div class="or-message-content collapsed">' + contentHtml + '</div>' +
        '</div>';
    }

    renderSystemMessageWithTags(content) {
        // Reuse the shared method for XML tag rendering
        return this.renderMessageWithTags(content);
    }

    getTagColorClass(tagName) {
        const colors = {
            // Identity tags (purple)
            'role': 'or-xml-role',
            'topic_definition': 'or-xml-role',
            // Critical rules (red)
            'critical_rules': 'or-xml-critical',
            'truth_protocol': 'or-xml-critical',
            'limit_exceeded': 'or-xml-critical',
            // Process tags (blue)
            'algorithm': 'or-xml-process',
            'task': 'or-xml-process',
            'goal': 'or-xml-process',
            'tools_protocol': 'or-xml-process',
            'instructions': 'or-xml-process',
            // Data tags (amber)
            'user_profile': 'or-xml-data',
            'recent_topics': 'or-xml-data',
            'topics': 'or-xml-data',
            'context': 'or-xml-data',
            'current_facts': 'or-xml-data',
            'conversation': 'or-xml-data',
            'memory_layers': 'or-xml-data',
            'retrieved_context': 'or-xml-data',
            'topic': 'or-xml-data',
            // Constraints tags (gray)
            'constraints': 'or-xml-constraints',
            'rules': 'or-xml-constraints',
            'summary': 'or-xml-constraints',
            'content': 'or-xml-constraints',
            // Output tags (green)
            'output': 'or-xml-output',
            'output_format': 'or-xml-output'
        };
        return colors[tagName.toLowerCase()] || 'or-xml-default';
    }

    parseAttributes(attrString) {
        const attrs = {};
        const regex = /(\w+)="([^"]*)"/g;
        let match;
        while ((match = regex.exec(attrString)) !== null) {
            attrs[match[1]] = match[2];
        }
        return attrs;
    }

    renderToolMessage(msg) {
        const content = this.getTextContent(msg.content);
        const toolCallId = msg.tool_call_id || '';

        let displayContent = content;
        try {
            const parsed = JSON.parse(content);
            displayContent = JSON.stringify(parsed, null, 2);
        } catch (e) {}

        return '<div class="or-message or-message-tool">' +
            '<div class="or-role">Tool Result' + (toolCallId ? ' <code class="or-tool-id">' + this.escapeHtml(toolCallId) + '</code>' : '') + '</div>' +
            '<div class="or-message-content"><pre>' + this.escapeHtml(displayContent) + '</pre></div>' +
        '</div>';
    }

    renderContent(content) {
        if (typeof content === 'string') {
            return '<div class="or-text">' + this.escapeHtml(content) + '</div>';
        }

        if (Array.isArray(content)) {
            let html = '';
            for (let i = 0; i < content.length; i++) {
                html += this.renderContentPart(content[i]);
            }
            return html;
        }

        return '<pre>' + this.escapeHtml(JSON.stringify(content, null, 2)) + '</pre>';
    }

    renderContentPart(part) {
        if (!part || typeof part !== 'object') {
            return '';
        }

        const type = part.type;

        if (type === 'text') {
            return '<div class="or-text">' + this.escapeHtml(part.text || '') + '</div>';
        }

        if (type === 'image_url') {
            const url = (part.image_url && part.image_url.url) || '';
            if (url.startsWith('data:image')) {
                return '<div class="or-image"><img src="' + url + '" alt="Uploaded image" /><span class="or-image-badge"><i class="bi bi-image"></i> Image</span></div>';
            } else {
                const truncUrl = url.length > 50 ? url.substring(0, 50) + '...' : url;
                return '<div class="or-multimodal-badge"><i class="bi bi-image"></i> Image URL: <code>' + this.escapeHtml(truncUrl) + '</code></div>';
            }
        }

        if (type === 'input_audio') {
            const format = (part.input_audio && part.input_audio.format) || 'audio';
            return '<div class="or-multimodal-badge"><i class="bi bi-mic"></i> Audio (' + this.escapeHtml(format) + ')</div>';
        }

        if (type === 'file' || type === 'document') {
            return '<div class="or-multimodal-badge"><i class="bi bi-file-earmark"></i> Document</div>';
        }

        return '<pre>' + this.escapeHtml(JSON.stringify(part, null, 2)) + '</pre>';
    }

    renderToolCalls(toolCalls) {
        let html = '';
        for (let i = 0; i < toolCalls.length; i++) {
            const tc = toolCalls[i];
            const name = (tc.function && tc.function.name) || 'unknown';
            let args = (tc.function && tc.function.arguments) || '{}';

            try {
                args = JSON.stringify(JSON.parse(args), null, 2);
            } catch (e) {}

            html += '<div class="or-tool-call">' +
                '<span class="or-tool-badge"><i class="bi bi-gear"></i> Tool Call</span> ' +
                '<code>' + this.escapeHtml(name) + '</code>' +
                (tc.id ? '<span class="or-tool-id">' + this.escapeHtml(tc.id) + '</span>' : '') +
                '<pre class="or-tool-args">' + this.escapeHtml(args) + '</pre>' +
            '</div>';
        }
        return html;
    }

    renderTools() {
        if (!this.data.tools || !this.data.tools.length) {
            return '';
        }

        let toolsHtml = '';
        for (let i = 0; i < this.data.tools.length; i++) {
            const tool = this.data.tools[i];
            const fn = tool.function || {};
            const name = fn.name || 'unknown';
            const desc = fn.description || '';
            const params = fn.parameters ? JSON.stringify(fn.parameters, null, 2) : '{}';

            toolsHtml += '<div class="or-tool">' +
                '<code class="or-tool-name">' + this.escapeHtml(name) + '</code>' +
                '<div class="or-tool-desc">' + this.escapeHtml(desc) + '</div>' +
                '<details><summary style="font-size: 0.75rem; cursor: pointer; color: #6b7280; margin-top: 0.25rem;">Parameters</summary>' +
                '<pre class="or-tool-schema">' + this.escapeHtml(params) + '</pre></details>' +
            '</div>';
        }

        return '<div class="or-tools-section">' +
            '<div class="or-section-header" onclick="toggleORSection(this)">' +
                '<span><i class="bi bi-tools"></i> Available Tools (' + this.data.tools.length + ')</span>' +
                '<i class="bi bi-chevron-down"></i>' +
            '</div>' +
            '<div class="or-section-content collapsed">' + toolsHtml + '</div>' +
        '</div>';
    }

    getTextContent(content) {
        if (typeof content === 'string') {
            return content;
        }
        if (Array.isArray(content)) {
            let text = '';
            for (let i = 0; i < content.length; i++) {
                if (content[i].type === 'text') {
                    text += (content[i].text || '') + '\n';
                }
            }
            return text.trim();
        }
        return JSON.stringify(content);
    }

    escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }
}

class OpenRouterResponseViewer {
    constructor(containerId, jsonString) {
        this.container = document.getElementById(containerId);
        this.data = null;

        try {
            this.data = JSON.parse(jsonString);
        } catch (e) {
            this.container.innerHTML = '<div class="or-error"><i class="bi bi-exclamation-triangle"></i> Invalid JSON: ' + this.escapeHtml(e.message) + '</div>';
            return;
        }

        this.render();
    }

    render() {
        const html = `
            ${this.renderHeader()}
            ${this.renderChoices()}
        `;
        this.container.innerHTML = html;
    }

    renderHeader() {
        const badges = [];

        // Response ID
        if (this.data.id) {
            badges.push('<span class="orr-id-badge">' + this.escapeHtml(this.data.id) + '</span>');
        }

        // Model
        if (this.data.model) {
            const modelDisplay = this.data.model.split('/').pop();
            badges.push('<span class="orr-model-badge">' + this.escapeHtml(modelDisplay) + '</span>');
        }

        // Finish reason from first choice
        if (this.data.choices && this.data.choices.length > 0) {
            const finishReason = this.data.choices[0].finish_reason || '';
            if (finishReason) {
                const finishClass = this.getFinishReasonClass(finishReason);
                badges.push('<span class="orr-finish-badge ' + finishClass + '"><i class="bi bi-check-circle"></i> ' + this.escapeHtml(finishReason) + '</span>');
            }
        }

        // Usage stats
        let usageHtml = '<div class="orr-usage">';
        if (this.data.usage) {
            if (this.data.usage.prompt_tokens !== undefined) {
                usageHtml += '<span class="orr-usage-badge"><i class="bi bi-arrow-up"></i> ' + this.data.usage.prompt_tokens + '</span>';
            }
            if (this.data.usage.completion_tokens !== undefined) {
                usageHtml += '<span class="orr-usage-badge"><i class="bi bi-arrow-down"></i> ' + this.data.usage.completion_tokens + '</span>';
            }
            if (this.data.usage.total_tokens !== undefined) {
                usageHtml += '<span class="orr-usage-badge"><i class="bi bi-calculator"></i> ' + this.data.usage.total_tokens + '</span>';
            }
            if (this.data.usage.cost !== undefined && this.data.usage.cost !== null) {
                usageHtml += '<span class="orr-usage-badge orr-cost-badge"><i class="bi bi-currency-dollar"></i> ' + this.data.usage.cost.toFixed(6) + '</span>';
            }
        }
        usageHtml += '</div>';

        return '<div class="orr-header">' + badges.join('') + usageHtml + '</div>';
    }

    getFinishReasonClass(reason) {
        const classes = {
            'stop': 'orr-finish-stop',
            'end_turn': 'orr-finish-stop',
            'tool_calls': 'orr-finish-tool_calls',
            'length': 'orr-finish-length',
            'max_tokens': 'orr-finish-max_tokens',
            'content_filter': 'orr-finish-content_filter'
        };
        return classes[reason] || 'orr-finish-default';
    }

    renderChoices() {
        if (!this.data.choices || !this.data.choices.length) {
            return '<div class="text-muted">No choices in response</div>';
        }

        let html = '<div class="orr-choices">';
        for (let i = 0; i < this.data.choices.length; i++) {
            html += this.renderChoice(this.data.choices[i], i);
        }
        html += '</div>';
        return html;
    }

    renderChoice(choice, idx) {
        const message = choice.message || {};
        const role = message.role || 'assistant';
        const content = message.content || '';
        const toolCalls = message.tool_calls || [];
        const reasoningDetails = message.reasoning_details || null;

        let html = '<div class="orr-choice">';
        html += '<div class="orr-choice-header">';
        if (this.data.choices.length > 1) {
            html += '<span class="orr-choice-index">Choice ' + idx + '</span>';
        }
        html += '<span class="orr-role">' + this.escapeHtml(role) + '</span>';
        html += '</div>';

        // Content
        if (content) {
            html += '<div class="orr-content">' + this.escapeHtml(content) + '</div>';
        }

        // Tool calls
        if (toolCalls.length > 0) {
            html += this.renderToolCalls(toolCalls);
        }

        // Reasoning details (extended thinking)
        if (reasoningDetails) {
            html += this.renderReasoningDetails(reasoningDetails);
        }

        html += '</div>';
        return html;
    }

    renderToolCalls(toolCalls) {
        let html = '';
        for (let i = 0; i < toolCalls.length; i++) {
            const tc = toolCalls[i];
            const name = (tc.function && tc.function.name) || 'unknown';
            let args = (tc.function && tc.function.arguments) || '{}';

            try {
                args = JSON.stringify(JSON.parse(args), null, 2);
            } catch (e) {}

            html += '<div class="or-tool-call">' +
                '<span class="or-tool-badge"><i class="bi bi-gear"></i> Tool Call</span> ' +
                '<code>' + this.escapeHtml(name) + '</code>' +
                (tc.id ? '<span class="or-tool-id">' + this.escapeHtml(tc.id) + '</span>' : '') +
                '<pre class="or-tool-args">' + this.escapeHtml(args) + '</pre>' +
            '</div>';
        }
        return html;
    }

    renderReasoningDetails(details) {
        // Details can be array or string depending on provider
        let content = '';
        if (Array.isArray(details)) {
            for (let i = 0; i < details.length; i++) {
                const d = details[i];
                if (d.type === 'thinking' && d.thinking) {
                    content += d.thinking + '\n';
                } else if (typeof d === 'string') {
                    content += d + '\n';
                }
            }
        } else if (typeof details === 'string') {
            content = details;
        } else {
            content = JSON.stringify(details, null, 2);
        }

        if (!content.trim()) return '';

        const uniqueId = 'reasoning-' + Math.random().toString(36).substr(2, 9);
        return '<div class="orr-reasoning">' +
            '<div class="orr-reasoning-header" onclick="document.getElementById(\'' + uniqueId + '\').classList.toggle(\'collapsed\')">' +
                '<i class="bi bi-lightbulb"></i> Reasoning / Extended Thinking' +
            '</div>' +
            '<div id="' + uniqueId + '" class="orr-reasoning-content collapsed">' + this.escapeHtml(content.trim()) + '</div>' +
        '</div>';
    }

    escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }
}

// Initialize viewers on page load
document.addEventListener('DOMContentLoaded', function() {
    {{range $idx, $log := .Data.Logs}}
    {{if not $log.ConversationTurns}}
    {{if $log.InputContext}}
    new OpenRouterRequestViewer('or-request-{{$idx}}', {{$log.InputContext | jsString}});
    {{end}}
    {{if $log.OutputContext}}
    new OpenRouterResponseViewer('or-response-{{$idx}}', {{$log.OutputContext | jsString}});
    {{end}}
    {{end}}
    {{end}}
});
</script>
{{end}}
