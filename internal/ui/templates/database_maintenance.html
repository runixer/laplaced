{{template "layout.html" .}}

{{define "title"}}Database Maintenance{{end}}

{{define "content"}}
<div class="container mt-4">

    <!-- Database Health Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Database Health</span>
            <button class="btn btn-sm btn-primary" onclick="loadHealth()" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
        <div class="card-body">
            <div id="healthLoading" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div id="healthContent" style="display: none;">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 id="totalTopics">-</h3>
                                <small class="text-muted">Total Topics</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 id="avgSize">-</h3>
                                <small class="text-muted">Avg Size (chars)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card" id="orphanedCard">
                            <div class="card-body text-center">
                                <h3 id="orphanedTopics">-</h3>
                                <small class="text-muted">Orphaned Topics</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card" id="zeroSizeCard">
                            <div class="card-body text-center">
                                <h3 id="zeroSizeTopics">-</h3>
                                <small class="text-muted">Zero-Size Topics</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="card" id="largeCard">
                            <div class="card-body text-center">
                                <h3 id="largeTopics">-</h3>
                                <small class="text-muted">Large Topics (&gt;25K)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card" id="overlappingCard">
                            <div class="card-body text-center">
                                <h3 id="overlappingPairs">-</h3>
                                <small class="text-muted">Overlapping Pairs</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card" id="factsOrphanedCard">
                            <div class="card-body text-center">
                                <h3 id="factsOnOrphaned">-</h3>
                                <small class="text-muted">Facts on Orphaned</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Large Topics List -->
                <div id="largeTopicsList" class="mt-4" style="display: none;">
                    <h6>Large Topics</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Size</th>
                                    <th>Summary</th>
                                </tr>
                            </thead>
                            <tbody id="largeTopicsBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="healthError" class="alert alert-danger" style="display: none;"></div>
        </div>
    </div>

    <!-- Repair Card -->
    <div class="card mb-4">
        <div class="card-header">Repair Database</div>
        <div class="card-body">
            <p class="text-muted">
                Repairs orphaned topics, relinks facts to valid topics, and recalculates topic sizes.
            </p>
            <div class="d-flex gap-2">
                <button class="btn btn-warning" onclick="runRepair(true)" id="dryRunBtn">
                    <i class="bi bi-search"></i> Dry Run (Preview)
                </button>
                <button class="btn btn-danger" onclick="runRepair(false)" id="repairBtn">
                    <i class="bi bi-wrench"></i> Repair Now
                </button>
            </div>
            <div id="repairResult" class="mt-3" style="display: none;">
                <div class="alert" id="repairAlert">
                    <h6 id="repairTitle"></h6>
                    <ul class="mb-0" id="repairStats"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Cross-User Contamination Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>ðŸ”’ Cross-User Contamination</span>
            <button class="btn btn-sm btn-primary" onclick="loadContamination()" id="contaminationRefreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Check
            </button>
        </div>
        <div class="card-body">
            <p class="text-muted">
                Detects topics containing messages from multiple users (data isolation violation).
                This can happen when merging/splitting topics with global message ID ranges.
            </p>
            <div id="contaminationLoading" class="text-center py-3" style="display: none;">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Checking...</span>
                </div>
            </div>
            <div id="contaminationContent" style="display: none;">
                <div class="alert" id="contaminationAlert">
                    <strong id="contaminationCount">0</strong> contaminated topics found
                </div>
                <div id="contaminationList" class="mt-3" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Topic ID</th>
                                    <th>Owner</th>
                                    <th>Foreign Users</th>
                                    <th>Foreign Msgs</th>
                                    <th>Summary</th>
                                </tr>
                            </thead>
                            <tbody id="contaminationBody">
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-warning" onclick="fixContamination(true)" id="contaminationDryRunBtn">
                            <i class="bi bi-search"></i> Dry Run
                        </button>
                        <button class="btn btn-danger" onclick="fixContamination(false)" id="contaminationFixBtn">
                            <i class="bi bi-shield-check"></i> Fix (Unlink Foreign Messages)
                        </button>
                    </div>
                </div>
                <div id="contaminationFixResult" class="mt-3" style="display: none;">
                    <div class="alert" id="contaminationFixAlert">
                        <h6 id="contaminationFixTitle"></h6>
                        <p id="contaminationFixStats" class="mb-0"></p>
                    </div>
                </div>
            </div>
            <div id="contaminationError" class="alert alert-danger mt-2" style="display: none;"></div>
        </div>
    </div>

    <!-- Split Large Topics Card -->
    <div class="card mb-4">
        <div class="card-header">Split Large Topics</div>
        <div class="card-body">
            <p class="text-muted">
                Splits topics larger than the threshold into smaller, more focused topics using LLM analysis.
            </p>
            <div class="row g-3 align-items-end">
                <div class="col-auto">
                    <label for="splitThreshold" class="form-label">Threshold (chars)</label>
                    <input type="number" class="form-control" id="splitThreshold" value="25000" min="5000" step="1000">
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="runSplit()" id="splitBtn">
                        <i class="bi bi-scissors"></i> Split Large Topics
                    </button>
                </div>
            </div>
            <div id="splitResult" class="mt-3" style="display: none;">
                <div class="alert" id="splitAlert">
                    <h6 id="splitTitle"></h6>
                    <pre id="splitStats" class="mb-0" style="white-space: pre-wrap;"></pre>
                </div>
            </div>
        </div>
    </div>

</div>
{{end}}

{{define "scripts"}}
<script>
const userId = {{.SelectedUserID}};

function setCardStatus(cardId, count) {
    const card = document.getElementById(cardId);
    if (!card) return;
    card.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'bg-light');
    if (count === 0) {
        card.classList.add('bg-light');
    } else if (count < 10) {
        card.classList.add('bg-warning');
    } else {
        card.classList.add('bg-danger');
    }
}

async function loadHealth() {
    document.getElementById('healthLoading').style.display = 'block';
    document.getElementById('healthContent').style.display = 'none';
    document.getElementById('healthError').style.display = 'none';
    document.getElementById('refreshBtn').disabled = true;

    try {
        const url = userId ? `/ui/debug/database/health?user_id=${userId}` : '/ui/debug/database/health';
        const resp = await fetch(url);
        const data = await resp.json();

        if (!resp.ok) {
            throw new Error(data.error || 'Failed to load health data');
        }

        document.getElementById('totalTopics').textContent = data.total_topics;
        document.getElementById('avgSize').textContent = data.avg_topic_size.toLocaleString();
        document.getElementById('orphanedTopics').textContent = data.orphaned_topics;
        document.getElementById('zeroSizeTopics').textContent = data.zero_size_topics;
        document.getElementById('largeTopics').textContent = data.large_topics;
        document.getElementById('overlappingPairs').textContent = data.overlapping_pairs;
        document.getElementById('factsOnOrphaned').textContent = data.facts_on_orphaned;

        setCardStatus('orphanedCard', data.orphaned_topics);
        setCardStatus('zeroSizeCard', data.zero_size_topics);
        setCardStatus('largeCard', data.large_topics);
        setCardStatus('overlappingCard', data.overlapping_pairs);
        setCardStatus('factsOrphanedCard', data.facts_on_orphaned);

        // Show large topics list
        if (data.large_topics_list && data.large_topics_list.length > 0) {
            const tbody = document.getElementById('largeTopicsBody');
            tbody.innerHTML = '';
            for (const t of data.large_topics_list) {
                const row = document.createElement('tr');
                const topicUrl = userId ? `/ui/topics?topic_id=${t.id}&user_id=${userId}` : `/ui/topics?topic_id=${t.id}`;
                row.innerHTML = `<td><a href="${topicUrl}">${t.id}</a></td><td>${t.size_chars.toLocaleString()}</td><td>${escapeHtml(t.summary)}</td>`;
                tbody.appendChild(row);
            }
            document.getElementById('largeTopicsList').style.display = 'block';
        } else {
            document.getElementById('largeTopicsList').style.display = 'none';
        }

        document.getElementById('healthContent').style.display = 'block';
    } catch (err) {
        document.getElementById('healthError').style.display = 'block';
        document.getElementById('healthError').textContent = err.message;
    } finally {
        document.getElementById('healthLoading').style.display = 'none';
        document.getElementById('refreshBtn').disabled = false;
    }
}

async function runRepair(dryRun) {
    const btn = dryRun ? document.getElementById('dryRunBtn') : document.getElementById('repairBtn');
    btn.disabled = true;
    document.getElementById('repairResult').style.display = 'none';

    try {
        const resp = await fetch('/ui/debug/database/repair', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: userId || 0, dry_run: dryRun})
        });
        const data = await resp.json();

        const alert = document.getElementById('repairAlert');
        const title = document.getElementById('repairTitle');
        const stats = document.getElementById('repairStats');

        alert.classList.remove('alert-success', 'alert-warning', 'alert-danger', 'alert-info');

        if (!resp.ok) {
            alert.classList.add('alert-danger');
            title.textContent = 'Error';
            stats.innerHTML = `<li>${data.error}</li>`;
        } else {
            alert.classList.add(dryRun ? 'alert-info' : 'alert-success');
            title.textContent = dryRun ? 'Dry Run Results (no changes made)' : 'Repair Complete';
            stats.innerHTML = `
                <li>Orphaned topics ${dryRun ? 'to delete' : 'deleted'}: ${data.orphaned_topics_deleted}</li>
                <li>Facts ${dryRun ? 'to relink' : 'relinked'}: ${data.facts_relinked}</li>
                <li>Topic sizes ${dryRun ? 'to recalculate' : 'recalculated'}: ${data.sizes_recalculated}</li>
            `;
            // Refresh health after repair
            if (!dryRun) {
                loadHealth();
            }
        }

        document.getElementById('repairResult').style.display = 'block';
    } catch (err) {
        alert('Request failed: ' + err.message);
    } finally {
        btn.disabled = false;
    }
}

async function runSplit() {
    const threshold = parseInt(document.getElementById('splitThreshold').value);
    if (!threshold || threshold < 5000) {
        alert('Threshold must be at least 5000');
        return;
    }

    const btn = document.getElementById('splitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Splitting...';
    document.getElementById('splitResult').style.display = 'none';

    try {
        const resp = await fetch('/ui/debug/split', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: userId || 0, threshold_chars: threshold})
        });
        const data = await resp.json();

        const alert = document.getElementById('splitAlert');
        const title = document.getElementById('splitTitle');
        const stats = document.getElementById('splitStats');

        alert.classList.remove('alert-success', 'alert-warning', 'alert-danger');

        if (!resp.ok || data.error) {
            alert.classList.add('alert-danger');
            title.textContent = 'Error';
            stats.textContent = data.error || 'Unknown error';
        } else {
            alert.classList.add('alert-success');
            title.textContent = 'Split Complete';
            stats.textContent = JSON.stringify(data.stats, null, 2);
            // Refresh health after split
            loadHealth();
        }

        document.getElementById('splitResult').style.display = 'block';
    } catch (err) {
        alert('Request failed: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-scissors"></i> Split Large Topics';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function loadContamination() {
    document.getElementById('contaminationLoading').style.display = 'block';
    document.getElementById('contaminationContent').style.display = 'none';
    document.getElementById('contaminationError').style.display = 'none';
    document.getElementById('contaminationRefreshBtn').disabled = true;

    try {
        const url = userId ? `/ui/debug/database/contamination?user_id=${userId}` : '/ui/debug/database/contamination';
        const resp = await fetch(url);
        const data = await resp.json();

        if (!resp.ok) {
            throw new Error(data.error || 'Failed to check contamination');
        }

        const count = data.total_contaminated || 0;
        document.getElementById('contaminationCount').textContent = count;

        const alertEl = document.getElementById('contaminationAlert');
        alertEl.classList.remove('alert-success', 'alert-danger', 'alert-warning');

        if (count === 0) {
            alertEl.classList.add('alert-success');
            document.getElementById('contaminationList').style.display = 'none';
        } else {
            alertEl.classList.add('alert-danger');
            // Populate table
            const tbody = document.getElementById('contaminationBody');
            tbody.innerHTML = '';
            for (const t of data.contaminated_topics || []) {
                const row = document.createElement('tr');
                const topicUrl = `/ui/topics?topic_id=${t.topic_id}&user_id=${t.topic_owner}`;
                const truncatedSummary = t.topic_summary.length > 100 ? t.topic_summary.substring(0, 100) + '...' : t.topic_summary;
                row.innerHTML = `
                    <td><a href="${topicUrl}">${t.topic_id}</a></td>
                    <td>${t.topic_owner}</td>
                    <td>${t.foreign_users.join(', ')}</td>
                    <td><span class="badge bg-danger">${t.foreign_msg_count}</span></td>
                    <td title="${escapeHtml(t.topic_summary)}">${escapeHtml(truncatedSummary)}</td>
                `;
                tbody.appendChild(row);
            }
            document.getElementById('contaminationList').style.display = 'block';
        }

        document.getElementById('contaminationContent').style.display = 'block';
    } catch (err) {
        document.getElementById('contaminationError').style.display = 'block';
        document.getElementById('contaminationError').textContent = err.message;
    } finally {
        document.getElementById('contaminationLoading').style.display = 'none';
        document.getElementById('contaminationRefreshBtn').disabled = false;
    }
}

async function fixContamination(dryRun) {
    const btn = dryRun ? document.getElementById('contaminationDryRunBtn') : document.getElementById('contaminationFixBtn');
    btn.disabled = true;
    document.getElementById('contaminationFixResult').style.display = 'none';

    try {
        const resp = await fetch('/ui/debug/database/contamination/fix', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user_id: userId || 0, dry_run: dryRun})
        });
        const data = await resp.json();

        const alertEl = document.getElementById('contaminationFixAlert');
        const title = document.getElementById('contaminationFixTitle');
        const stats = document.getElementById('contaminationFixStats');

        alertEl.classList.remove('alert-success', 'alert-warning', 'alert-danger', 'alert-info');

        if (!resp.ok) {
            alertEl.classList.add('alert-danger');
            title.textContent = 'Error';
            stats.textContent = data.error;
        } else {
            alertEl.classList.add(dryRun ? 'alert-info' : 'alert-success');
            title.textContent = dryRun ? 'Dry Run Results' : 'Fix Complete';
            stats.textContent = `Messages ${dryRun ? 'to unlink' : 'unlinked'}: ${data.stats.messages_unlinked}`;

            // Refresh after fix
            if (!dryRun) {
                loadContamination();
                loadHealth();
            }
        }

        document.getElementById('contaminationFixResult').style.display = 'block';
    } catch (err) {
        alert('Request failed: ' + err.message);
    } finally {
        btn.disabled = false;
    }
}

// Load health on page load
document.addEventListener('DOMContentLoaded', loadHealth);
</script>
{{end}}
