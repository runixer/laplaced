{{define "title"}}Test Chat{{end}}
{{define "styles"}}
<style>
    .chat-container {
        display: flex;
        gap: 1.5rem;
        height: calc(100vh - 200px);
        min-height: 500px;
    }
    .chat-panel {
        flex: 6;
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .debug-panel {
        flex: 4;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        overflow-y: auto;
    }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .message {
        max-width: 85%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        word-wrap: break-word;
    }
    .message.user {
        align-self: flex-end;
        background: #0d6efd;
        color: white;
        border-bottom-right-radius: 0.25rem;
    }
    .message.assistant {
        align-self: flex-start;
        background: #e9ecef;
        color: #212529;
        border-bottom-left-radius: 0.25rem;
    }
    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    .chat-input-area {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
        background: #fff;
    }
    .chat-input-row {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
    }
    .chat-input-row textarea {
        flex: 1;
        resize: none;
        border-radius: 1.5rem;
        padding: 0.75rem 1rem;
        border: 1px solid #dee2e6;
    }
    .chat-input-row textarea:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.15);
    }
    .send-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .debug-section {
        background: #fff;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .debug-section h6 {
        color: #6c757d;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .debug-row {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
        font-size: 0.875rem;
    }
    .debug-row .label {
        color: #6c757d;
    }
    .debug-row .value {
        font-weight: 500;
    }
    .debug-row .value.highlight {
        color: #0d6efd;
    }
    .context-preview {
        font-family: monospace;
        font-size: 0.75rem;
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
    }
    .loading-indicator {
        display: none;
        text-align: center;
        padding: 1rem;
        color: #6c757d;
    }
    .loading-indicator.active {
        display: block;
    }
    .typing-dots {
        display: inline-flex;
        gap: 0.25rem;
    }
    .typing-dots span {
        width: 8px;
        height: 8px;
        background: #6c757d;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
    .empty-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        text-align: center;
        padding: 2rem;
    }
    .empty-chat h5 {
        margin-bottom: 0.5rem;
    }
    .options-row {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 0.75rem;
    }
</style>
{{end}}

{{define "content"}}
<div class="chat-container">
    <!-- Chat Panel -->
    <div class="chat-panel">
        <div class="chat-messages" id="chatMessages">
            {{if .Messages}}
                {{range .Messages}}
                <div class="message {{.Role}}">
                    <div class="message-content">{{.Content}}</div>
                    <div class="message-time">{{.CreatedAt.Format "15:04"}}</div>
                </div>
                {{end}}
            {{else}}
                <div class="empty-chat">
                    <h5>No messages yet</h5>
                    <p>Send a message to test the bot pipeline</p>
                </div>
            {{end}}
        </div>

        <div id="loadingIndicator" class="loading-indicator">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
            <div class="mt-2">Bot is thinking...</div>
        </div>

        <div class="chat-input-area">
            <div class="options-row">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="saveToHistory" checked>
                    <label class="form-check-label" for="saveToHistory">Save to history</label>
                </div>
            </div>
            <div class="chat-input-row">
                <textarea id="messageInput" rows="1" placeholder="Type a message..."
                    onkeydown="handleKeyDown(event)"></textarea>
                <button class="btn btn-primary send-btn" onclick="sendMessage()" id="sendBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel">
        <div class="debug-section">
            <h6>Timing</h6>
            <div class="debug-row">
                <span class="label">Total</span>
                <span class="value highlight" id="timingTotal">-</span>
            </div>
            <div class="debug-row">
                <span class="label">Embedding</span>
                <span class="value" id="timingEmbedding">-</span>
            </div>
            <div class="debug-row">
                <span class="label">Vector Search</span>
                <span class="value" id="timingSearch">-</span>
            </div>
            <div class="debug-row">
                <span class="label">LLM Generation</span>
                <span class="value" id="timingLLM">-</span>
            </div>
        </div>

        <div class="debug-section">
            <h6>Token Usage</h6>
            <div class="debug-row">
                <span class="label">Prompt</span>
                <span class="value" id="tokensPrompt">-</span>
            </div>
            <div class="debug-row">
                <span class="label">Completion</span>
                <span class="value" id="tokensCompletion">-</span>
            </div>
            <div class="debug-row">
                <span class="label">Cost</span>
                <span class="value highlight" id="tokensCost">-</span>
            </div>
        </div>

        <div class="debug-section">
            <h6>Context</h6>
            <div class="debug-row">
                <span class="label">Topics Matched</span>
                <span class="value" id="contextTopics">-</span>
            </div>
            <div class="debug-row">
                <span class="label">Messages Injected</span>
                <span class="value" id="contextFacts">-</span>
            </div>
            <details class="mt-2">
                <summary class="text-primary" style="cursor: pointer; font-size: 0.875rem;">View Context</summary>
                <div class="context-preview mt-2" id="contextPreview">-</div>
            </details>
        </div>
    </div>
</div>

{{end}}

{{define "scripts"}}
<script>
const userId = {{.SelectedUserID}};
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const loadingIndicator = document.getElementById('loadingIndicator');
const sendBtn = document.getElementById('sendBtn');

function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addMessage(role, content) {
    // Remove empty state if present
    const emptyChat = chatMessages.querySelector('.empty-chat');
    if (emptyChat) {
        emptyChat.remove();
    }

    const msg = document.createElement('div');
    msg.className = 'message ' + role;

    const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    msg.innerHTML = `
        <div class="message-content">${escapeHtml(content)}</div>
        <div class="message-time">${time}</div>
    `;

    chatMessages.appendChild(msg);
    scrollToBottom();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function setLoading(loading) {
    loadingIndicator.classList.toggle('active', loading);
    sendBtn.disabled = loading;
    messageInput.disabled = loading;
}

function updateDebugPanel(data) {
    document.getElementById('timingTotal').textContent = data.timing.total_ms + ' ms';
    document.getElementById('timingEmbedding').textContent = data.timing.embedding_ms + ' ms';
    document.getElementById('timingSearch').textContent = data.timing.search_ms + ' ms';
    document.getElementById('timingLLM').textContent = data.timing.llm_ms + ' ms';

    document.getElementById('tokensPrompt').textContent = data.tokens.prompt.toLocaleString();
    document.getElementById('tokensCompletion').textContent = data.tokens.completion.toLocaleString();
    document.getElementById('tokensCost').textContent = '$' + data.cost_usd.toFixed(4);

    document.getElementById('contextTopics').textContent = data.context.topics_matched;
    document.getElementById('contextFacts').textContent = data.context.facts_injected;
    document.getElementById('contextPreview').textContent = data.context.preview || '-';
}

async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || !userId) {
        if (!userId) alert('Please select a user first');
        return;
    }

    const saveToHistory = document.getElementById('saveToHistory').checked;

    // Add user message to chat
    addMessage('user', message);
    messageInput.value = '';

    setLoading(true);

    try {
        const response = await fetch('/ui/debug/chat/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: userId,
                message: message,
                save_to_history: saveToHistory
            })
        });

        const data = await response.json();

        if (data.error) {
            addMessage('assistant', 'Error: ' + data.error);
        } else {
            addMessage('assistant', data.response);
            updateDebugPanel(data);
        }
    } catch (err) {
        addMessage('assistant', 'Error: ' + err.message);
    } finally {
        setLoading(false);
        messageInput.focus();
    }
}

// Auto-resize textarea
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Scroll to bottom on load
scrollToBottom();
</script>
{{end}}
