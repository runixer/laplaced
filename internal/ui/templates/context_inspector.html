{{define "title"}}Context Inspector{{end}}
{{define "styles"}}
<style>
    .inspector-card { border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .inspector-header { background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e0e0e0; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .inspector-body { padding: 15px; }
    
    .stat-badge { font-size: 0.85rem; margin-right: 10px; }
    
    .progress-stacked { height: 20px; border-radius: 4px; overflow: hidden; display: flex; background-color: #e9ecef; margin-bottom: 15px; }
    .progress-segment { display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold; transition: width 0.3s ease; }
    
    .bg-system { background-color: #0d6efd; }
    .bg-user-facts { background-color: #198754; }
    .bg-env-facts { background-color: #0dcaf0; color: black; }
    .bg-rag { background-color: #ffc107; color: black; }
    .bg-history { background-color: #6c757d; }
    
    .context-section { margin-bottom: 10px; }
    .context-pre { white-space: pre-wrap; font-family: monospace; font-size: 11px; background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 300px; overflow-y: auto; }
    
    .msg-bubble { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; position: relative; }
    .msg-user { background-color: #e3f2fd; border-left: 4px solid #0d6efd; }
    .msg-assistant { background-color: #fff3e0; border-left: 4px solid #fd7e14; }
    .msg-tool { background-color: #f8f9fa; border-left: 4px solid #6c757d; font-family: monospace; font-size: 11px; }
    .msg-role { font-weight: bold; font-size: 11px; margin-bottom: 4px; text-transform: uppercase; color: #666; }
    
    .tool-call-badge { background: #6c757d; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
    
    .accordion-button::after { width: 10px; height: 10px; background-size: 10px; }
    .accordion-button { padding: 8px 12px; font-size: 14px; }
    .accordion-body { padding: 0; }
</style>
{{end}}

{{define "content"}}
<div class="container-fluid">
    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <input type="text" id="filterInput" class="form-control" onkeyup="filterLogs()" placeholder="Filter by User ID or Query...">
        </div>
    </div>

    <div id="logsContainer">
        {{range .Data}}
        <div class="inspector-card" data-filter="{{.UserID}} {{.OriginalQuery}}">
            <div class="inspector-header">
                <div>
                    <span class="fw-bold me-2">User: {{.UserID}}</span>
                    <span class="text-muted small">{{.CreatedAt.Format "2006-01-02 15:04:05"}}</span>
                </div>
                <div>
                    <span class="badge bg-secondary stat-badge">Tokens: {{.GenerationTokens}}</span>
                    <span class="badge bg-success stat-badge">Cost: ${{printf "%.5f" .TotalCostUSD}}</span>
                    <span class="badge bg-info text-dark stat-badge">Ctx Size: {{.Stats.TotalSize}} chars</span>
                </div>
            </div>
            
            <div class="inspector-body">
                <!-- Query -->
                <div class="mb-3">
                    <strong>Query:</strong> {{.OriginalQuery}}
                    {{if ne .OriginalQuery .EnrichedQuery}}
                    <div class="text-success small mt-1"><strong>Enriched:</strong> {{.EnrichedQuery}}</div>
                    {{end}}
                </div>

                <!-- Composition Bar -->
                <div class="progress-stacked" title="Context Composition">
                    {{if gt .Stats.SystemPromptPct 0.0}}
                    <div class="progress-segment bg-system" style="width: {{printf "%.1f" .Stats.SystemPromptPct}}%" title="System Prompt: {{printf "%.1f" .Stats.SystemPromptPct}}%">SYS</div>
                    {{end}}
                    {{if gt .Stats.UserFactsPct 0.0}}
                    <div class="progress-segment bg-user-facts" style="width: {{printf "%.1f" .Stats.UserFactsPct}}%" title="User Facts: {{printf "%.1f" .Stats.UserFactsPct}}%">USR</div>
                    {{end}}
                    {{if gt .Stats.EnvFactsPct 0.0}}
                    <div class="progress-segment bg-env-facts" style="width: {{printf "%.1f" .Stats.EnvFactsPct}}%" title="Env Facts: {{printf "%.1f" .Stats.EnvFactsPct}}%">ENV</div>
                    {{end}}
                    {{if gt .Stats.RAGContextPct 0.0}}
                    <div class="progress-segment bg-rag" style="width: {{printf "%.1f" .Stats.RAGContextPct}}%" title="RAG Context: {{printf "%.1f" .Stats.RAGContextPct}}%">RAG</div>
                    {{end}}
                    {{if gt .Stats.HistoryPct 0.0}}
                    <div class="progress-segment bg-history" style="width: {{printf "%.1f" .Stats.HistoryPct}}%" title="History: {{printf "%.1f" .Stats.HistoryPct}}%">HIST</div>
                    {{end}}
                </div>

                <div class="row">
                    <!-- Left Column: Context Components -->
                    <div class="col-md-6">
                        <h6 class="text-muted border-bottom pb-2 mb-3">Context Components</h6>
                        
                        <div class="accordion" id="accordion-{{.ID}}">
                            <!-- System Prompt -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSys-{{.ID}}">
                                        <span class="badge bg-system me-2">{{printf "%.1f" .Stats.SystemPromptPct}}%</span> System Prompt
                                    </button>
                                </h2>
                                <div id="collapseSys-{{.ID}}" class="accordion-collapse collapse" data-bs-parent="#accordion-{{.ID}}">
                                    <div class="accordion-body">
                                        <div class="context-pre">{{.SystemPromptPart}}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- User Facts -->
                            {{if .UserFactsPart}}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUser-{{.ID}}">
                                        <span class="badge bg-user-facts me-2">{{printf "%.1f" .Stats.UserFactsPct}}%</span> User Facts
                                    </button>
                                </h2>
                                <div id="collapseUser-{{.ID}}" class="accordion-collapse collapse" data-bs-parent="#accordion-{{.ID}}">
                                    <div class="accordion-body">
                                        <div class="context-pre">{{.UserFactsPart}}</div>
                                    </div>
                                </div>
                            </div>
                            {{end}}

                            <!-- Env Facts -->
                            {{if .EnvFactsPart}}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEnv-{{.ID}}">
                                        <span class="badge bg-env-facts me-2">{{printf "%.1f" .Stats.EnvFactsPct}}%</span> Environment Facts
                                    </button>
                                </h2>
                                <div id="collapseEnv-{{.ID}}" class="accordion-collapse collapse" data-bs-parent="#accordion-{{.ID}}">
                                    <div class="accordion-body">
                                        <div class="context-pre">{{.EnvFactsPart}}</div>
                                    </div>
                                </div>
                            </div>
                            {{end}}

                            <!-- RAG Context -->
                            {{if .RAGContextPart}}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRAG-{{.ID}}">
                                        <span class="badge bg-rag me-2">{{printf "%.1f" .Stats.RAGContextPct}}%</span> RAG Context
                                    </button>
                                </h2>
                                <div id="collapseRAG-{{.ID}}" class="accordion-collapse collapse" data-bs-parent="#accordion-{{.ID}}">
                                    <div class="accordion-body">
                                        <div class="context-pre">{{.RAGContextPart}}</div>
                                        <!-- Raw Results -->
                                        {{if .ParsedResults}}
                                        <div class="p-2 bg-light border-top">
                                            <small class="fw-bold text-muted">Source Topics:</small>
                                            {{if isTopicList .ParsedResults}}
                                                {{range .ParsedResults}}
                                                <div class="small mt-1">
                                                    â€¢ {{.Topic.Summary}} ({{printf "%.2f" .Score}})
                                                </div>
                                                {{end}}
                                            {{else}}
                                                <div class="small mt-1 text-muted">Legacy format</div>
                                            {{end}}
                                        </div>
                                        {{end}}
                                    </div>
                                </div>
                            </div>
                            {{end}}
                        </div>
                    </div>

                    <!-- Right Column: Conversation Flow -->
                    <div class="col-md-6">
                        <h6 class="text-muted border-bottom pb-2 mb-3">Conversation Flow (Last 4)</h6>
                        
                        <div style="background: #fcfcfc; padding: 10px; border: 1px solid #eee; border-radius: 8px; max-height: 600px; overflow-y: auto;">
                            {{range .LastMessages}}
                                <div class="msg-bubble msg-{{.Role}}">
                                    <div class="msg-role">{{.Role}}</div>
                                    <div style="white-space: pre-wrap;">{{renderContent .Content}}</div>
                                    
                                    {{if .ToolCalls}}
                                    <div class="mt-2 pt-2 border-top border-secondary-subtle">
                                        {{range .ToolCalls}}
                                        <div class="mb-1">
                                            <span class="tool-call-badge">ðŸ›  {{.Function.Name}}</span>
                                            <pre class="small text-muted mb-0" style="background: #f8f9fa; padding: 5px; border-radius: 4px; overflow-x: auto;"><code>{{prettyJSON .Function.Arguments}}</code></pre>
                                        </div>
                                        {{end}}
                                    </div>
                                    {{end}}
                                </div>
                            {{end}}
                            
                            <!-- Tool Outputs (if any in ToolCalls list from view) -->
                            {{range .ToolCalls}}
                                {{if eq .Role "tool"}}
                                <div class="msg-bubble msg-tool">
                                    <div class="msg-role">TOOL OUTPUT ({{.ToolCallID}})</div>
                                    <div style="white-space: pre-wrap;">{{renderContent .Content}}</div>
                                </div>
                                {{end}}
                            {{end}}

                            <!-- Final Response -->
                            <div class="msg-bubble msg-assistant border-2 border-warning">
                                <div class="msg-role text-warning">FINAL RESPONSE</div>
                                <div style="white-space: pre-wrap;">{{.LLMResponse}}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {{end}}
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
function filterLogs() {
    const input = document.getElementById('filterInput');
    const filter = input.value.toUpperCase();
    const cards = document.getElementsByClassName('inspector-card');

    for (let i = 0; i < cards.length; i++) {
        const filterText = cards[i].getAttribute('data-filter');
        if (filterText.toUpperCase().indexOf(filter) > -1) {
            cards[i].style.display = "";
        } else {
            cards[i].style.display = "none";
        }
    }
}
</script>
{{end}}
